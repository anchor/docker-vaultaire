#!/bin/sh
set -x
set -e
#
# Build and cache project dependencies
#

#FIXME ENABLE
#docker pull anchor.private/afcowie/haskell:latest

#
# Copy in any changes to our build infrastructure
#

rsync -a src/ cache

docker run -t -v ${PWD}/cache:/src:rw anchor.private/afcowie/haskell /src/.build/dependencies
ID=`docker ps -q -l`
docker commit ${ID} anchor.private/engineering/vaultaire:dependencies
#FIXME ENABLE
#docker rm ${ID}


#
# Build actual binaries. This could be updated to use a locally up to date
# tree rather than pulling from Gitub, but that requires finding a valid way
# to inject said current sources.
#

docker run -t -v ${PWD}/cache:/src:rw anchor.private/engineering/vaultaire:dependencies /src/.build/application
ID=`docker ps -q -l`

# FIXME TEMPORARY?
docker commit ${ID} anchor.private/engineering/vaultaire:application
#FIXME ENABLE
#docker rm ${ID}

#
# Extract the binary artifacts
#

rsync -av /cache/.cabal/bin release

#
# Finally build the release image
#
# TODO replace with /src/.build/release

docker build -t anchor.private/engineering/vaultaire:2.5.1 --rm release
rm -r release/bin/

docker tag anchor.private/engineering/vaultaire:2.5.1 anchor.private/engineering/vaultaire:latest
docker push anchor.private/engineering/vaultaire:2.5.1
docker push anchor.private/engineering/vaultaire:latest

