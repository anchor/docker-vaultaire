#
# Build and cache project dependencies
#

docker pull anchor.private/afcowie/haskell:latest

docker build -t anchor.private/engineering/vaultaire:dependencies --rm dependencies
if [ $? -ne 0 ] ; then exit ; fi

#
# Build actual binaries. This could be updated to use a locally up to date
# tree rather than pulling from Gitub, but that requires finding a valid way
# to inject said current sources.
#

docker build -t anchor.private/engineering/vaultaire:application --rm application
if [ $? -ne 0 ] ; then exit ; fi

#
# Extract the binary artifacts
#

docker run -t anchor.private/engineering/vaultaire:application true
ID=`docker ps -q -l`
docker cp ${ID}:/.cabal/bin/ release
docker rm ${ID}

#
# Finally build the release image
#

docker build -t anchor.private/engineering/vaultaire:2.5.1 --rm release
if [ $? -ne 0 ] ; then exit ; fi
rm -r release/bin/

docker tag anchor.private/engineering/vaultaire:2.5.1 anchor.private/engineering/vaultaire:latest
docker push anchor.private/engineering/vaultaire:2.5.1
docker push anchor.private/engineering/vaultaire:latest

